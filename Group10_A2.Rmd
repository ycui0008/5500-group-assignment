---
title: "A2"
author: "Group 10"
date: "9/12/2021"
output: 
  bookdown::pdf_document2:
    toc: yes
    toc_depth: '2'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = 'center')
library(tidyverse)
library(visdat)
library(simputation)
library(fastDummies) # does not work for multi-level factors?
```


```{r read_data}
bankruptcy <- readRDS(here::here("data/Bankruptcy.rds"))
```

# Data description

Data are collected on `r ncol(bankruptcy)` variables each representing different measures of status of `r nrow(bankruptcy)` bankrupt companies in the US. These are:

* Name of the firm (`Name`)
* Total assets (in millions of dollars) (`Assets`)
* City where filing took place (`CityFiled`)
* U.S CIP at the time of filing (`CPI`)
* Length of bankruptcy process (`DaysIn`)
* CityFiled, categorized as Wilmington (DE), New York (NY) or all other cities (OT) (`DENYOther`)
* Earnings (operating income) at time of filing (in millions of dollars) (`Ebit`)
* Number of employees before bankruptcy (`Employees`)
* Number of union employees before bankruptcy (`EmplUnion`)
* Total number of other bankrupcy filings in the year of this filing (`FilingRate`)
* Short description of the event that ended the firmâ€™s existence (`FirmEnd`)
* Gross Domestic Product for the Quarter in which the case was filed (`GDP`)
* The population of the firms headquarters city (`HeadCityPop`)
* The distance in miles from the firms headquarters city to the city in which the case was filed (`HeadCourtCityToDE`)
* The state in which firms headquarters is located (`HeadStAtFiling`)
* Total amount of money owed (in millions of dollars) (`Liab`)
* Categorical variable where numbers from 1 to 12 correspond to months from Jan to Dec (`MonthFiled`)
* Prime rate of interest on the bankruptcy filing date (`PrimeFiling`)
* Sales before bankruptcy (in dollars) (`Sales`)
* Standard industrial clasification code (`SICMajGroup`)
* Year bankruptcy was filed (`YearFiled`)

Among these variables, `Assets`, `Ebit`, `GDP`, `Liab`, `Employees` and `Sales` are the measures of the status of the companies. `CPI`, `PrimeFiling` and `CityFiled` describe the external environment of the companies. `FirmEnd` tells three different endings of the companies: merged with others, bankruptcy, and continuing the operations.

```{r vismiss, fig.cap = "Missing values in the data set"}
vis_miss(bankruptcy)
```

Figure \ref(fig:vismiss) shows the missing values in the data set. The most missing values are in `EmplUnion`; fortunately, this variable is not important.

# Data cleaning 

```{r pairplot, fig.cap = "Overview of all numeric variables in the data set"}
bankruptcy %>% 
  dplyr::select_if(is.numeric) %>% 
  GGally::ggpairs()
```



Figure \@ref(fig:pairplot) shows the relations between any two of the numeric variables in the data set. We can clearly see some outliers in Figure \@ref(fig:pairplot). In addition, we can tell some linear relationship between `Assets` and `Ebit`. For `Sales`, it is difficult to tell any clear relationship with any one of the other variables. We assume that the firms which have similar amount of assets, EBIT, and liability would have similar sales in same industry. Therefore, we use `impute_knn()` to impute missing values in `Sales`. Following same logic, we can impute missing values in `Employees` as well.

credibiliy:

## Imputation

```{r}
# impute_lm(bankruptcy, Liab ~ Assets) %>%
#   impute_lm(Ebit ~ Assets) %>%
#   impute_knn(Sales ~ Assets + Ebit + Liab, pool = "univariate", k = 5) %>%
#   impute_knn(Employees ~ Assets + Ebit + Sales, pool = "univariate", k = 5) %>%
#   impute_lm(DaysIn ~ Assets) %>%

bankruptcy %>% 
  separate(SICMajGroup, c("group_code", "group_name"), " ", extra = "merge") %>% 
  mutate(group_code = as.numeric(group_code))-> bankruptcy_imp

bankruptcy_clean <- bankruptcy_imp %>% 
  mutate(group_code = group_code - min(bankruptcy_imp$group_code),
         group_code = as.factor(group_code))

impute_lm(bankruptcy_clean, Liab ~ Assets) %>% 
  impute_lm(Ebit ~ Assets) %>%
  impute_knn(Sales ~ Assets + Ebit + Liab + group_code, pool = "univariate", k = 5) %>% 
  impute_knn(Employees ~ Assets + Ebit + Sales + group_code, pool = "univariate", k = 5) -> bankruptcy_imp
```

```
impute_lm(bankruptcy_clean, Liab ~ Assets) %>% # impute `Liab`
  impute_lm(Ebit ~ Assets) %>% # impute `Ebit`
  impute_knn(Sales ~ Assets + Ebit + Liab + group_code, pool = "univariate", k = 5) %>% # impute `Sales`
  impute_knn(Employees ~ Assets + Ebit + Sales + group_code, pool = "univariate", k = 5) # impute `Employees`
  -> bankruptcy_imp
```

`bankruptcy_imp` is the data set after imputation. In Figure \@ref(fig:vismissimp), we can see that all important numeric variables have no missing values.

```{r vismissimp, fig.cap = "Check missing values after imputation"}
vis_miss(bankruptcy_imp)
```


# PCA

```{r}
pcaout <- bankruptcy_clean %>% 
  mutate(Name = abbreviate(Name)) %>% 
  column_to_rownames('Name') %>% 
  dplyr::select_if(is.numeric) %>% 
  select(-DaysIn, -EmplUnion, -HeadCourtCityToDE) %>% 
  # select(Assets, CPI, FilingRate, GDP, HeadCityPop, MonthFiled, PrimeFiling, YearFiled) %>%
  prcomp(scale. =TRUE)
```

```{r}
summary(pcaout)
```

```{r}
screeplot(pcaout, type = 'l')
```


```{r}
biplot(pcaout, scale = 0)
```

outliers:




















